open Camlboy_lib
open Uints

module Camlboy = Camlboy.Make (Cartridge_mbc1)

let run_test_rom_and_print_framebuffer file =
  let rom_bytes = Read_rom_file.f file  in
  let camlboy = Camlboy.create_with_rom ~rom_bytes ~print_serial_port:false in
  let rec loop () =
    let run_result = Camlboy.run_instruction camlboy in
    let prev_instr = Camlboy.For_tests.prev_inst camlboy in
    match prev_instr, run_result with
    | JR (None, i8), Frame_ended famebuffer ->
      if Int8.to_int i8 = -3 then begin
        Printf.printf "%s\n" @@ Camlboy.show camlboy;
        famebuffer
        |> Array.iteri (fun i row ->
            if row |> Array.for_all (fun color -> color = `White) then
              ()
            else begin
              let show_color = function
                | `Black -> '#'
                | `Dark_gray -> '@'
                | `Light_gray -> 'x'
                | `White -> '-'
              in
              Printf.printf "%03d:" i;
              row |> Array.iter (fun color -> show_color color |> print_char);
              print_newline ()
            end
          )
      end
    | _, _ -> loop ()
  in
  loop ()

let%expect_test "div_timing.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/div_timing.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##-------#--------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#-----##--------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#-----#--------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-----#--------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#------#--------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##------###-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##------##---------------------###----------------------##------##---------------------------------------------------
    033:-----------------#---#--------------------#--#----#--#-------------------#---#--------------------#--#----#--#--------------------------------------------------
    034:-----------------####-------#------------#----#--#----#-----------------#-----------#------------#----#--#----#-------------------------------------------------
    035:-----------------#---#-------------------#----#--#----#-----------------#------------------------#----#--#----#-------------------------------------------------
    036:-----------------#---#--------------------#--#----#--#-------------------#---#--------------------#--#----#--#--------------------------------------------------
    037:-----------------####-------#--------------##------##---------------------###-------#--------------##------##---------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####-------------------####-----####--------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#-----------------------#---#---#----#-------------------------------------------------
    042:-----------------#---#------#------------#----#-----#--------------------####-------#------------#---#----####--------------------------------------------------
    043:-----------------#---#-------------------#----#-----#--------------------#-----------------------#---#---#----#-------------------------------------------------
    044:-----------------#---#--------------------#--#------#--------------------#-----------------------#---#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##------###-------------------#####------#------------####-----####--------------------------------------------------
    048:-----------------#----#------------------#####---#####-------------------#-------------------------##-------#---------------------------------------------------
    049:-----------------#----#------------------#-------#-----------------------#------------------------#--#-----##---------------------------------------------------
    050:-----------------######-----#------------####----####--------------------#----------#------------#----#---#-#---------------------------------------------------
    051:-----------------#----#------------------#-------#-----------------------#-----------------------#----#--#--#---------------------------------------------------
    052:-----------------#----#------------------#-------#-----------------------#------------------------#--#---#####--------------------------------------------------
    053:-----------------#----#-----#------------#-------#-----------------------######-----#--------------##-------#---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:-----------------####----------------------###---#---#--------------------###----------------------###---#---#--------------------------------------------------
    089:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    090:-----------------####-------#-------------#---#--#-#--------------------#-----------#-------------#---#--#-#----------------------------------------------------
    091:-----------------#---#--------------------#---#--###--------------------#-------------------------#---#--###----------------------------------------------------
    092:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    093:-----------------####-------#--------------###---#---#--------------------###-------#--------------###---#---#--------------------------------------------------
    096:-----------------####----------------------###---#---#----------------------------------------------------------------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#------------------------------------------------------------------------------------------------------------
    099:-----------------#---#--------------------#---#--###------------------------------------------------------------------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    101:-----------------####-------#--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "tim00.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/tim00.gb";

  [%expect {|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##----######------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#####-------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-------#------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####---------------------##----######-------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#------------------------#--#---#------------------------------------------------------
    042:-----------------#---#------#------------#----#---#-#--------------------####-------#------------#----#--#####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#--#--------------------#-----------------------#----#-------#-------------------------------------------------
    044:-----------------#---#--------------------#--#---#####-------------------#------------------------#--#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##-------#--------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tim01.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/tim01.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##-----####-------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#----#------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#---#####------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#--------#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-----####-------------------#####---------------------##-----####--------------------------------------------------
    041:-----------------#---#--------------------#--#---#----#------------------#------------------------#--#---#----#-------------------------------------------------
    042:-----------------#---#------#------------#----#---####-------------------####-------#------------#----#--#----#-------------------------------------------------
    043:-----------------#---#-------------------#----#--#----#------------------#-----------------------#----#---#####-------------------------------------------------
    044:-----------------#---#--------------------#--#---#----#------------------#------------------------#--#--------#-------------------------------------------------
    045:-----------------####-------#--------------##-----####-------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tim10.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/tim10.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##----######------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#####-------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-------#------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####---------------------##----######-------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#------------------------#--#---#------------------------------------------------------
    042:-----------------#---#------#------------#----#---#-#--------------------####-------#------------#----#--#####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#--#--------------------#-----------------------#----#-------#-------------------------------------------------
    044:-----------------#---#--------------------#--#---#####-------------------#------------------------#--#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##-------#--------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tim11.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/tim11.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##----######------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#####-------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-------#------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####---------------------##----######-------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#------------------------#--#---#------------------------------------------------------
    042:-----------------#---#------#------------#----#---#-#--------------------####-------#------------#----#--#####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#--#--------------------#-----------------------#----#-------#-------------------------------------------------
    044:-----------------#---#--------------------#--#---#####-------------------#------------------------#--#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##-------#--------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tima_reload.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/tima_reload.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##--------------------#####---#####-------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##--------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------####----####--------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#-------#-----------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#------------#-------#####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####--------------------#####---#####--------------------###--------------------#####---#####--------------------------------------------------
    033:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    034:-----------------####-------#------------####----####-------------------#-----------#------------####----####---------------------------------------------------
    035:-----------------#---#-------------------#-------#----------------------#------------------------#-------#------------------------------------------------------
    036:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    037:-----------------####-------#------------#-------#####--------------------###-------#------------#-------#####--------------------------------------------------
    040:-----------------####--------------------#####---#####-------------------#####---------------------##------##---------------------------------------------------
    041:-----------------#---#-------------------#-------#-----------------------#------------------------#--#----#--#--------------------------------------------------
    042:-----------------#---#------#------------####----####--------------------####-------#------------#----#--#----#-------------------------------------------------
    043:-----------------#---#-------------------#-------#-----------------------#-----------------------#----#--#----#-------------------------------------------------
    044:-----------------#---#-------------------#-------#-----------------------#------------------------#--#----#--#--------------------------------------------------
    045:-----------------####-------#------------#-------#-----------------------#####------#--------------##------##---------------------------------------------------
    048:-----------------#----#------------------#####---#####-------------------#-------------------------##------##---------------------------------------------------
    049:-----------------#----#------------------#-------#-----------------------#------------------------#--#----#--#--------------------------------------------------
    050:-----------------######-----#------------####----####--------------------#----------#------------#----#--#----#-------------------------------------------------
    051:-----------------#----#------------------#-------#-----------------------#-----------------------#----#--#----#-------------------------------------------------
    052:-----------------#----#------------------#-------#-----------------------#------------------------#--#----#--#--------------------------------------------------
    053:-----------------#----#-----#------------#-------#-----------------------######-----#--------------##------##---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:-----------------####----------------------###---#---#--------------------###----------------------###---#---#--------------------------------------------------
    089:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    090:-----------------####-------#-------------#---#--#-#--------------------#-----------#-------------#---#--#-#----------------------------------------------------
    091:-----------------#---#--------------------#---#--###--------------------#-------------------------#---#--###----------------------------------------------------
    092:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    093:-----------------####-------#--------------###---#---#--------------------###-------#--------------###---#---#--------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#--------------------------------------------------
    104:-----------------#----#--------------------###---#---#-------------------#-------------------------###---#---#--------------------------------------------------
    105:-----------------#----#-------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    106:-----------------######-----#-------------#---#--#-#---------------------#----------#-------------#---#--#-#----------------------------------------------------
    107:-----------------#----#-------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    108:-----------------#----#-------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    109:-----------------#----#-----#--------------###---#---#-------------------######-----#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tima_div_write.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/div_write.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486D
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "tima_write_reloading.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/tma_write_reloading.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$4841 DE:$01B8 HL:$FF40 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##--------------------#####---#####-------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##--------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------####----####--------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#-------#-----------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#------------#-------#####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####--------------------#####---#####--------------------###--------------------#####---#####--------------------------------------------------
    033:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    034:-----------------####-------#------------####----####-------------------#-----------#------------####----####---------------------------------------------------
    035:-----------------#---#-------------------#-------#----------------------#------------------------#-------#------------------------------------------------------
    036:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    037:-----------------####-------#------------#-------#####--------------------###-------#------------#-------#####--------------------------------------------------
    040:-----------------####--------------------######--#####-------------------#####-------------------#####---#####--------------------------------------------------
    041:-----------------#---#-----------------------#---#-----------------------#-----------------------#-------#------------------------------------------------------
    042:-----------------#---#------#---------------#----####--------------------####-------#------------####----####---------------------------------------------------
    043:-----------------#---#---------------------#-----#-----------------------#-----------------------#-------#------------------------------------------------------
    044:-----------------#---#--------------------#------#-----------------------#-----------------------#-------#------------------------------------------------------
    045:-----------------####-------#------------#-------#-----------------------#####------#------------#-------#####--------------------------------------------------
    048:-----------------#----#------------------######--#####-------------------#-----------------------#####---#####--------------------------------------------------
    049:-----------------#----#----------------------#---#-----------------------#-----------------------#-------#------------------------------------------------------
    050:-----------------######-----#---------------#----####--------------------#----------#------------####----####---------------------------------------------------
    051:-----------------#----#--------------------#-----#-----------------------#-----------------------#-------#------------------------------------------------------
    052:-----------------#----#-------------------#------#-----------------------#-----------------------#-------#------------------------------------------------------
    053:-----------------#----#-----#------------#-------#-----------------------######-----#------------#-------#####--------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:--------------------------------------------------------------------------###----------------------###---#---#--------------------------------------------------
    089:-------------------------------------------------------------------------#---#--------------------#---#--#--#---------------------------------------------------
    090:------------------------------------------------------------------------#-----------#-------------#---#--#-#----------------------------------------------------
    091:------------------------------------------------------------------------#-------------------------#---#--###----------------------------------------------------
    092:-------------------------------------------------------------------------#---#--------------------#---#--#--#---------------------------------------------------
    093:--------------------------------------------------------------------------###-------#--------------###---#---#--------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####-------------------######--#####------#-------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#---------------------------#---#----------#-------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#---------------#----####-------#-------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#-------------------------#-----#----------#-------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#------#------------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#------------#-------#----------#-------------------------------------------
    104:-------------------------------------------------------------------------#-------------------------###---#---#--------------------------------------------------
    105:-------------------------------------------------------------------------#------------------------#---#--#--#---------------------------------------------------
    106:-------------------------------------------------------------------------#----------#-------------#---#--#-#----------------------------------------------------
    107:-------------------------------------------------------------------------#------------------------#---#--###----------------------------------------------------
    108:-------------------------------------------------------------------------#------------------------#---#--#--#---------------------------------------------------
    109:-------------------------------------------------------------------------######-----#--------------###---#---#--------------------------------------------------
    120:-#######----------------------------------------------------#------#------------------#-------------------------------------------------------------------------
    121:----#-----####-----###-----#---------------##-----####-------------#------####--------#-------------------------------------------------------------------------
    122:----#----#----#---#-------####-------------#----------#-----#------#-----#----#---#####-------------------------------------------------------------------------
    123:----#----######----##------#--------------###-----#####-----#------#-----######--#----#-------------------------------------------------------------------------
    124:----#----#-----------#-----#---------------#-----#---##-----#------#-----#-------#---##-------------------------------------------------------------------------
    125:----#-----####----###------##--------------#------###-#-----#------##-----####----###-#------------------------------------------------------------------------- |}]

let%expect_test "rapid_toggle.gb" =
  run_test_rom_and_print_framebuffer "../../resource/test_roms/mooneye/rapid_toggle.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$4841 DE:$020C HL:$FF40 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##------##--------------------#####---------------------##------##---------------------------------------------------
    025:-------------------##---------------------#--#----#--#-------------------#------------------------#--#----#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#----#------------------####-------#------------#----#--#----#-------------------------------------------------
    027:------------------####-------------------#----#--#----#------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#----#--#-------------------#------------------------#--#----#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##------##--------------------#----------#--------------##------##---------------------------------------------------
    032:-----------------####--------------------#####----###---------------------###--------------------####-----####--------------------------------------------------
    033:-----------------#---#-------------------#-------#---#-------------------#---#-------------------#---#---#----#-------------------------------------------------
    034:-----------------####-------#------------####---#-----------------------#-----------#------------#---#-------#--------------------------------------------------
    035:-----------------#---#-------------------#------#-----------------------#------------------------#---#-----##---------------------------------------------------
    036:-----------------#---#-------------------#-------#---#-------------------#---#-------------------#---#---#----#-------------------------------------------------
    037:-----------------####-------#------------#--------###---------------------###-------#------------####-----####--------------------------------------------------
    040:-----------------####----------------------##------##--------------------#####-------------------####-----####--------------------------------------------------
    041:-----------------#---#--------------------#--#----#--#-------------------#-----------------------#---#---#----#-------------------------------------------------
    042:-----------------#---#------#------------#----#--#----#------------------####-------#------------#---#----####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#----#------------------#-----------------------#---#---#----#-------------------------------------------------
    044:-----------------#---#--------------------#--#----#--#-------------------#-----------------------#---#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##------##--------------------#####------#------------####-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:-----------------####--------------------#####---#####------#-------------###--------------------####-----####------#-------------------------------------------
    089:-----------------#---#-------------------#-------#----------#------------#---#-------------------#---#---#----#-----#-------------------------------------------
    090:-----------------####-------#------------####----####-------#-----------#-----------#------------#---#---#----#-----#-------------------------------------------
    091:-----------------#---#-------------------#-------#----------#-----------#------------------------#---#----#####-----#-------------------------------------------
    092:-----------------#---#-------------------#-------#-----------------------#---#-------------------#---#--------#-------------------------------------------------
    093:-----------------####-------#------------#-------#----------#-------------###-------#------------####-----####------#-------------------------------------------
    120:-#######----------------------------------------------------#------#------------------#-------------------------------------------------------------------------
    121:----#-----####-----###-----#---------------##-----####-------------#------####--------#-------------------------------------------------------------------------
    122:----#----#----#---#-------####-------------#----------#-----#------#-----#----#---#####-------------------------------------------------------------------------
    123:----#----######----##------#--------------###-----#####-----#------#-----######--#----#-------------------------------------------------------------------------
    124:----#----#-----------#-----#---------------#-----#---##-----#------#-----#-------#---##-------------------------------------------------------------------------
    125:----#-----####----###------##--------------#------###-#-----#------##-----####----###-#------------------------------------------------------------------------- |}]
